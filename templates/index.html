<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: stretch;
        }

        .chat-container {
            width: 100%;
            max-width: 800px;
            height: 100vh;
            background: white;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            padding: 10px;
            margin: 0;
            border-bottom: 1px solid #ddd;
            background-color: #f8f9fa;
            text-align: center;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #fafafa;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
        }

        .user-message {
            background-color: #007bff;
            color: white;
            margin-left: 20%;
        }

        .assistant-message {
            background-color: #e9ecef;
            color: #333;
            margin-right: 20%;
        }

        .reasoning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
            font-style: italic;
        }

        .input-section {
            padding: 10px;
            border-top: 1px solid #ddd;
            background-color: white;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
        }

        /* íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ */
        .file-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .file-preview-item {
            position: relative;
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px;
            max-width: 200px;
        }

        .file-preview-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 8px;
        }

        .file-preview-item .file-icon {
            width: 40px;
            height: 40px;
            background-color: #dc3545;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            margin-right: 8px;
            font-size: 18px;
        }

        .file-preview-item .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-preview-item .file-name {
            font-size: 12px;
            font-weight: 500;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ì˜¤ë¥˜ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .error-message {
            color: #dc3545;
            text-align: center;
            padding: 15px;
            margin: 10px 0;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            font-weight: 500;
        }

        .file-preview-item .file-size {
            font-size: 11px;
            color: #666;
        }

        .file-preview-item .remove-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-preview-item .remove-btn:hover {
            background: #c82333;
        }

        .text-input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            position: relative;
        }

        /* ì²¨ë¶€ ë²„íŠ¼ */
        .attach-button {
            width: 40px;
            height: 40px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0;
        }

        .attach-button:hover {
            background-color: #5a6268;
        }

        .attach-button:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .attach-button:disabled:hover {
            background-color: #adb5bd;
        }

        /* íŒŒì¼ ë©”ë‰´ */
        .file-menu {
            position: absolute;
            bottom: 50px;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 120px;
        }

        .file-menu button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            border-radius: 0;
        }

        .file-menu button:first-child {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .file-menu button:last-child {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .file-menu button:hover {
            background-color: #f8f9fa;
        }

        .file-inputs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .file-input {
            flex: 1;
        }

        #messageInput {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            font-family: Arial, sans-serif;
            resize: vertical;
            min-height: 20px;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.4;
        }

        label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            white-space: nowrap;
            margin-bottom: 12px;
        }

        #sendButton {
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            height: fit-content;
            margin-bottom: 0;
        }

        #sendButton:hover {
            background-color: #0056b3;
        }

        #sendButton:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .generated-image {
            max-width: 100%;
            border-radius: 8px;
            margin: 10px 0;
        }

        input[type="file"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
        }

        /* ì‚¬ìš©ì ë©”ì‹œì§€ì˜ íŒŒì¼ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .user-files {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .file-badge {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-block;
            margin: 2px;
        }

        /* Markdown ìŠ¤íƒ€ì¼ */
        .message h1, .message h2, .message h3, .message h4, .message h5, .message h6 {
            margin: 10px 0 5px 0;
            font-weight: bold;
        }

        .message h1 { font-size: 1.5em; }
        .message h2 { font-size: 1.3em; }
        .message h3 { font-size: 1.1em; }

        .message p {
            margin: 8px 0;
            line-height: 1.5;
        }

        .message ul, .message ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .message li {
            margin: 5px 0;
            line-height: 1.4;
        }

        .message code {
            background-color: #f4f4f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message pre {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .message pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
        }

        .message blockquote {
            border-left: 4px solid #ddd;
            margin: 10px 0;
            padding-left: 15px;
            color: #666;
            font-style: italic;
        }

        .message strong {
            font-weight: bold;
        }

        .message em {
            font-style: italic;
        }

        .message table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }

        .message th, .message td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .message th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        /* ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .thinking-message {
            display: flex;
            align-items: center;
            font-style: italic;
            color: #666;
        }

        /* ì €ì‘ê¶Œ ì •ë³´ ìŠ¤íƒ€ì¼ */
        .copyright {
            text-align: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-top: 1px solid #ddd;
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        .copyright a {
            color: #007bff;
            text-decoration: none;
        }

        .copyright a:hover {
            text-decoration: underline;
        }

    </style>
</head>
<body>
    <div class="chat-container">
        <h1>{{ title }}</h1>

        <div class="messages" id="messages"></div>

        <div class="input-section">
            <!-- ì—…ë¡œë“œëœ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
            <div id="filePreview" class="file-preview" style="display: none;"></div>

            <div class="text-input-container">
                <button id="attachButton" class="attach-button" onclick="toggleFileMenu()">
                    <span>+</span>
                </button>

                <!-- íŒŒì¼ ì—…ë¡œë“œ ë©”ë‰´ (ìˆ¨ê¹€) -->
                <div id="fileMenu" class="file-menu" style="display: none;">
                    <button onclick="triggerImageUpload()">ğŸ“· ì´ë¯¸ì§€</button>
                    <button onclick="triggerPdfUpload()">ğŸ“„ PDF</button>
                </div>

                <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ë“¤ -->
                <input type="file" id="imageInput" accept=".jfif,.pjp,.jpg,.pjpeg,.jpeg,.gif,.png" multiple style="display: none;" onchange="handleFileUpload(this, 'image')">
                <input type="file" id="pdfInput" accept=".pdf" multiple style="display: none;" onchange="handleFileUpload(this, 'pdf')">

                <textarea id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (Shift+Enterë¡œ ì¤„ë°”ê¿ˆ, Ctrl+Vë¡œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸°)" onkeydown="handleKeyDown(event)" oninput="autoResizeTextarea(this)" onpaste="handlePaste(event)" rows="1"></textarea>
                <button id="sendButton" onclick="sendMessage()">ì „ì†¡</button>
            </div>
        </div>

        <!-- ì €ì‘ê¶Œ ì •ë³´ -->
        <div class="copyright">
            <strong><a href="https://openai-api-agent.aicastle.school" target="_blank">OpenAI API Agent School</a></strong>
            | Copyright Â© 2025 <a href="https://aicastle.com" target="_blank">AICASTLE</a>)</div>
    </div>

    <script>
        let previousResponseId = null;
        let isProcessing = false;
        let uploadedFiles = []; // ì—…ë¡œë“œëœ íŒŒì¼ë“¤ì„ ì €ì¥í•˜ëŠ” ë°°ì—´

        function addMessage(content, isUser = false, files = []) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'assistant-message'}`;

            let messageContent = '';

            // ì–´ì‹œìŠ¤í„´íŠ¸ê°€ ìƒì„±í•œ ì´ë¯¸ì§€ì¸ ê²½ìš° (contentê°€ ì´ë¯¸ì§€ URLì´ê³  filesê°€ 'image'ì¸ ê²½ìš°)
            if (!isUser && files === 'image' && content) {
                messageContent = `<img src="${content}" class="generated-image" alt="Generated Image" style="max-width: 100%; height: auto; border-radius: 8px;">`;
            } else {
                // í…ìŠ¤íŠ¸ ë‚´ìš© ì²˜ë¦¬
                if (content) {
                    if (typeof marked !== 'undefined' && !isUser) {
                        messageContent += marked.parse(content);
                    } else {
                        messageContent += content.replace(/\n/g, '<br>');
                    }
                }

                // ì‚¬ìš©ì ë©”ì‹œì§€ì˜ ê²½ìš° íŒŒì¼ë“¤ë„ í•¨ê»˜ í‘œì‹œ
                if (isUser && files && Array.isArray(files) && files.length > 0) {
                    if (content) messageContent += '<br><br>';
                    messageContent += '<div class="user-files">';

                    for (const fileObj of files) {
                        if (fileObj.type === 'image') {
                            // ì´ë¯¸ì§€ íŒŒì¼ì¸ ê²½ìš° ì¸ë„¤ì¼ í‘œì‹œ
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const img = messageDiv.querySelector(`[data-file-id="${fileObj.id}"]`);
                                if (img) {
                                    img.src = e.target.result;
                                }
                            };
                            reader.readAsDataURL(fileObj.file);

                            messageContent += `<img data-file-id="${fileObj.id}" src="" style="max-width: 100px; max-height: 100px; margin: 2px; border-radius: 4px;" title="${fileObj.name}">`;
                        } else {
                            messageContent += `<span class="file-badge">ğŸ“„ ${fileObj.name}</span>`;
                        }
                    }
                    messageContent += '</div>';
                }
            }

            messageDiv.innerHTML = messageContent;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function setProcessing(processing) {
            isProcessing = processing;
            const sendButton = document.getElementById('sendButton');
            const messageInput = document.getElementById('messageInput');
            const attachButton = document.getElementById('attachButton');

            sendButton.disabled = processing;
            messageInput.disabled = processing;
            attachButton.disabled = processing;

            if (processing) {
                // ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€ ë°•ìŠ¤ë¥¼ ë¨¼ì € ìƒì„±í•˜ê³  ê·¸ ì•ˆì— ìŠ¤í”¼ë„ˆ í‘œì‹œ
                const messagesDiv = document.getElementById('messages');
                const assistantDiv = document.createElement('div');
                assistantDiv.className = 'message assistant-message';
                assistantDiv.id = 'current-assistant-message';
                assistantDiv.innerHTML = '<div class="spinner"></div>';
                messagesDiv.appendChild(assistantDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        // íŒŒì¼ ë©”ë‰´ í† ê¸€
        function toggleFileMenu() {
            const fileMenu = document.getElementById('fileMenu');
            fileMenu.style.display = fileMenu.style.display === 'none' ? 'block' : 'none';
        }

        // ì™¸ë¶€ í´ë¦­ì‹œ íŒŒì¼ ë©”ë‰´ ë‹«ê¸°
        document.addEventListener('click', function(event) {
            const fileMenu = document.getElementById('fileMenu');
            const attachButton = document.getElementById('attachButton');

            if (!fileMenu.contains(event.target) && !attachButton.contains(event.target)) {
                fileMenu.style.display = 'none';
            }
        });

        // íŒŒì¼ ì—…ë¡œë“œ íŠ¸ë¦¬ê±°
        function triggerImageUpload() {
            document.getElementById('imageInput').click();
            document.getElementById('fileMenu').style.display = 'none';
        }

        function triggerPdfUpload() {
            document.getElementById('pdfInput').click();
            document.getElementById('fileMenu').style.display = 'none';
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleFileUpload(input, type) {
            const files = Array.from(input.files);

            // ì§€ì›ë˜ëŠ” ì´ë¯¸ì§€ í¬ë§· ì •ì˜
            const supportedImageFormats = ['.jfif', '.pjp', '.jpg', '.pjpeg', '.jpeg', '.gif', '.png'];
            const supportedPdfFormats = ['.pdf'];

            files.forEach(file => {
                const fileName = file.name.toLowerCase();
                const fileExtension = '.' + fileName.split('.').pop();

                // íŒŒì¼ í¬ë§· ê²€ì¦
                if (type === 'image') {
                    if (!supportedImageFormats.includes(fileExtension)) {
                        alert(`ì§€ì›ë˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ í¬ë§·ì…ë‹ˆë‹¤: ${file.name}\nì§€ì›ë˜ëŠ” í¬ë§·: ${supportedImageFormats.join(', ')}`);
                        return;
                    }
                } else if (type === 'pdf') {
                    if (!supportedPdfFormats.includes(fileExtension)) {
                        alert(`ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í¬ë§·ì…ë‹ˆë‹¤: ${file.name}\nì§€ì›ë˜ëŠ” í¬ë§·: ${supportedPdfFormats.join(', ')}`);
                        return;
                    }
                }

                const fileObj = {
                    id: Date.now() + Math.random(),
                    file: file,
                    type: type,
                    name: file.name,
                    size: formatFileSize(file.size)
                };

                uploadedFiles.push(fileObj);

                if (type === 'image') {
                    createImagePreview(fileObj);
                } else {
                    createFilePreview(fileObj);
                }
            });

            updateFilePreviewVisibility();
            input.value = ''; // ì…ë ¥ ì´ˆê¸°í™”
        }

        // í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸°
        function handlePaste(event) {
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;

            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const file = item.getAsFile();
                    if (file) {
                        const fileObj = {
                            id: Date.now() + Math.random(),
                            file: file,
                            type: 'image',
                            name: `í´ë¦½ë³´ë“œ_ì´ë¯¸ì§€_${new Date().getTime()}.png`,
                            size: formatFileSize(file.size)
                        };

                        uploadedFiles.push(fileObj);
                        createImagePreview(fileObj);
                        updateFilePreviewVisibility();
                    }
                }
            }
        }

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ìƒì„±
        function createImagePreview(fileObj) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewItem = createPreviewItem(fileObj, e.target.result);
                document.getElementById('filePreview').appendChild(previewItem);
            };
            reader.readAsDataURL(fileObj.file);
        }

        // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ìƒì„± (PDF ë“±)
        function createFilePreview(fileObj) {
            const previewItem = createPreviewItem(fileObj, null);
            document.getElementById('filePreview').appendChild(previewItem);
        }

        // ë¯¸ë¦¬ë³´ê¸° ì•„ì´í…œ ìƒì„±
        function createPreviewItem(fileObj, imageSrc) {
            const div = document.createElement('div');
            div.className = 'file-preview-item';
            div.setAttribute('data-file-id', fileObj.id);

            let iconOrImage;
            if (imageSrc) {
                iconOrImage = `<img src="${imageSrc}" alt="${fileObj.name}">`;
            } else {
                iconOrImage = `<div class="file-icon">ğŸ“„</div>`;
            }

            div.innerHTML = `
                ${iconOrImage}
                <div class="file-info">
                    <div class="file-name">${fileObj.name}</div>
                    <div class="file-size">${fileObj.size}</div>
                </div>
                <button class="remove-btn" onclick="removeFile('${fileObj.id}')">Ã—</button>
            `;

            return div;
        }

        // íŒŒì¼ ì œê±°
        function removeFile(fileId) {
            uploadedFiles = uploadedFiles.filter(file => file.id != fileId);
            const previewItem = document.querySelector(`[data-file-id="${fileId}"]`);
            if (previewItem) {
                previewItem.remove();
            }
            updateFilePreviewVisibility();
        }

        // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ í‘œì‹œ/ìˆ¨ê¹€
        function updateFilePreviewVisibility() {
            const filePreview = document.getElementById('filePreview');
            filePreview.style.display = uploadedFiles.length > 0 ? 'flex' : 'none';
        }

        // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function fileToBase64Only(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // data:mime;base64, ë¶€ë¶„ì„ ì œê±°í•˜ê³  base64 ë¬¸ìì—´ë§Œ ë°˜í™˜
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter') {
                if (event.shiftKey) {
                    // Shift+Enter: ì¤„ë°”ê¿ˆ í—ˆìš© (ê¸°ë³¸ ë™ì‘)
                    autoResizeTextarea(event.target);
                    return true;
                } else {
                    // Enterë§Œ: ë©”ì‹œì§€ ì „ì†¡
                    event.preventDefault();
                    if (!isProcessing) {
                        sendMessage();
                    }
                    return false;
                }
            }
        }

        function autoResizeTextarea(textarea) {
            // textarea ë†’ì´ ìë™ ì¡°ì ˆ
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }

        async function sendMessage() {
            if (isProcessing) return;

            // ê¸°ì¡´ ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê±°
            const existingErrorMessages = document.querySelectorAll('.error-message');
            existingErrorMessages.forEach(errorMsg => errorMsg.remove());

            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();

            if (!messageText && uploadedFiles.length === 0) {
                alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ë¨¼ì € í™”ë©´ì— í‘œì‹œ
                addMessage(messageText, true, uploadedFiles);

                // ì²˜ë¦¬ ì¤‘ ìƒíƒœë¡œ ì„¤ì • (ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€ ë°•ìŠ¤ì™€ ìŠ¤í”¼ë„ˆ ìƒì„±)
                setProcessing(true);

                // ì…ë ¥ ë©”ì‹œì§€ êµ¬ì„± (íŒŒì¼ ì´ˆê¸°í™” ì „ì— ë¨¼ì € ì²˜ë¦¬)
                const inputContent = [];

                // ì—…ë¡œë“œëœ íŒŒì¼ë“¤ ì²˜ë¦¬
                for (const fileObj of uploadedFiles) {
                    if (fileObj.type === 'image') {
                        const imageBase64 = await fileToBase64(fileObj.file);
                        inputContent.push({
                            type: "input_image",
                            image_url: imageBase64
                        });
                    } else if (fileObj.type === 'pdf') {
                        const pdfBase64Only = await fileToBase64Only(fileObj.file);
                        inputContent.push({
                            type: "input_file",
                            filename: fileObj.name,
                            file_data: `data:application/pdf;base64,${pdfBase64Only}`
                        });
                    }
                }

                // í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì²˜ë¦¬
                if (messageText) {
                    inputContent.push({
                        type: "input_text",
                        text: messageText
                    });
                }

                // ì…ë ¥ í•„ë“œì™€ íŒŒì¼ ëª©ë¡ ì´ˆê¸°í™” (ë©”ì‹œì§€ êµ¬ì„± í›„)
                messageInput.value = '';
                uploadedFiles = [];
                document.getElementById('filePreview').innerHTML = '';
                updateFilePreviewVisibility();

                // textarea ë†’ì´ë„ ë¦¬ì…‹
                messageInput.style.height = 'auto';

                const inputMessage = [{
                    role: "user",
                    content: inputContent
                }];

                // API í˜¸ì¶œ (ìŠ¤íŠ¸ë¦¬ë°ë§Œ ì‚¬ìš©)
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        input_message: inputMessage,
                        previous_response_id: previousResponseId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let assistantMessageDiv = null;
                let accumulatedText = '';

                while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ') && line.trim() !== 'data: ') {
                                try {
                                    const jsonStr = line.slice(6).trim();
                                    if (jsonStr) {
                                        const data = JSON.parse(jsonStr);

                                        if (data.type === 'text_delta') {
                                            if (!assistantMessageDiv) {
                                                // ê¸°ì¡´ ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€ ë°•ìŠ¤ ì°¾ê¸° (ìŠ¤í”¼ë„ˆê°€ ìˆëŠ”)
                                                assistantMessageDiv = document.getElementById('current-assistant-message');
                                                if (!assistantMessageDiv) {
                                                    const messagesDiv = document.getElementById('messages');
                                                    assistantMessageDiv = document.createElement('div');
                                                    assistantMessageDiv.className = 'message assistant-message';
                                                    assistantMessageDiv.id = 'current-assistant-message';
                                                    messagesDiv.appendChild(assistantMessageDiv);
                                                }
                                            }

                                            accumulatedText += data.delta;

                                            // ìŠ¤í”¼ë„ˆì™€ í…ìŠ¤íŠ¸ë¥¼ í•¨ê»˜ í‘œì‹œ
                                            let content = '<div class="spinner"></div>';
                                            if (typeof marked !== 'undefined') {
                                                content += marked.parse(accumulatedText);
                                            } else {
                                                content += accumulatedText.replace(/\n/g, '<br>');
                                            }
                                            assistantMessageDiv.innerHTML = content;

                                            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;

                        } else if (data.type === 'image_generated') {
                            if (!assistantMessageDiv) {
                                // ê¸°ì¡´ ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€ ë°•ìŠ¤ ì°¾ê¸° (ìŠ¤í”¼ë„ˆê°€ ìˆëŠ”)
                                assistantMessageDiv = document.getElementById('current-assistant-message');
                                if (!assistantMessageDiv) {
                                    const messagesDiv = document.getElementById('messages');
                                    assistantMessageDiv = document.createElement('div');
                                    assistantMessageDiv.className = 'message assistant-message';
                                    assistantMessageDiv.id = 'current-assistant-message';
                                    messagesDiv.appendChild(assistantMessageDiv);
                                }
                            }

                            // ê¸°ì¡´ ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€ ë°•ìŠ¤ì— ì´ë¯¸ì§€ ì¶”ê°€
                            let content = '<div class="spinner"></div>';
                            if (accumulatedText) {
                                if (typeof marked !== 'undefined') {
                                    content += marked.parse(accumulatedText);
                                } else {
                                    content += accumulatedText.replace(/\n/g, '<br>');
                                }
                            }
                            content += `<img src="${data.image_url}" style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px;">`;
                            assistantMessageDiv.innerHTML = content;

                            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;                                        } else if (data.type === 'done') {
                                            // ì‘ë‹µ ì™„ë£Œ ì‹œ ìŠ¤í”¼ë„ˆ ì œê±°
                                            if (assistantMessageDiv) {
                                                const spinnerElement = assistantMessageDiv.querySelector('.spinner');
                                                if (spinnerElement) {
                                                    spinnerElement.remove();
                                                }
                                                assistantMessageDiv.id = ''; // ID ì œê±°
                                            }

                                            if (data.response_id) {
                                                previousResponseId = data.response_id;
                                            }
                                            console.log('Stream completed');
                                        }
                                    }
                                } catch (e) {
                                    console.error('JSON parsing error:', e);
                                    // JSON íŒŒì‹± ì—ëŸ¬ ì‹œì—ë„ ìŠ¤í”¼ë„ˆ ì œê±°í•˜ê³  ì˜¤ë¥˜ í‘œì‹œ
                                    const currentAssistantMessage = document.getElementById('current-assistant-message');
                                    if (currentAssistantMessage) {
                                        currentAssistantMessage.remove();
                                    }

                                    const messagesDiv = document.getElementById('messages');
                                    const errorDiv = document.createElement('div');
                                    errorDiv.className = 'error-message';
                                    errorDiv.textContent = 'ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                                    messagesDiv.appendChild(errorDiv);
                                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                                    break; // ìŠ¤íŠ¸ë¦¬ë° ë£¨í”„ ì¢…ë£Œ
                                }
                            }
                        }
                    }

            } catch (error) {
                console.error('Error:', error);

                // ìŠ¤í”¼ë„ˆê°€ ìˆëŠ” ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€ ë°•ìŠ¤ ì œê±°
                const currentAssistantMessage = document.getElementById('current-assistant-message');
                if (currentAssistantMessage) {
                    currentAssistantMessage.remove();
                }

                // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ì¤‘ì•™ ì •ë ¬í•´ì„œ í‘œì‹œ
                const messagesDiv = document.getElementById('messages');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
                messagesDiv.appendChild(errorDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } finally {
                setProcessing(false);
            }
        }

    </script>
</body>
</html>